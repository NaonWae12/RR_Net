# RRNET - Golden FreeRADIUS config (voucher-only, PAP + REST)
# This config follows RADIUS spec: PAP decodes User-Password to Cleartext-Password
# Cleartext-Password is then sent as plain text in JSON (valid, no binary issues)

server default {
	listen {
		type = auth
		ipaddr = *
		port = 0
	}

	listen {
		type = acct
		ipaddr = *
		port = 0
	}

	authorize {
		preprocess
		#
		# PAP is MANDATORY
		# This converts User-Password (binary) -> Cleartext-Password
		#
		pap
		#
		# Voucher-only flow:
		# If Cleartext-Password exists, delegate auth to REST
		#
		if (&Cleartext-Password) {
			update control {
				Auth-Type := REST
			}
		}
	}

	authenticate {
		Auth-Type PAP {
			pap
		}
		Auth-Type REST {
			update control {
				&REST-HTTP-Header := "X-RRNET-RADIUS-SECRET: $ENV{RRNET_RADIUS_REST_SECRET}"
			}

			rest
			#
			# rlm_rest returns:
			# - ok      → HTTP 2xx with no reply attrs
			# - updated → reply attrs set
			#
			if (ok || updated) {
				ok
			}
		}
	}

	preacct {
		preprocess
	}

	accounting {
		update control {
			# Use FreeRADIUS env var syntax for config-time expansion
			&REST-HTTP-Header := "X-RRNET-RADIUS-SECRET: $ENV{RRNET_RADIUS_REST_SECRET}"
		}

		rest
	}
}


