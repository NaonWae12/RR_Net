# RRNET - Golden FreeRADIUS config (voucher-only, PAP + REST)
# This config follows RADIUS spec: PAP decodes User-Password to Cleartext-Password
# Cleartext-Password is then sent as plain text in JSON (valid, no binary issues)

server default {
	listen {
		type = auth
		ipaddr = *
		port = 0
	}

	listen {
		type = acct
		ipaddr = *
		port = 0
	}

	authorize {
		preprocess
		#
		# PAP is MANDATORY
		# Set Auth-Type to PAP to allow PAP module to decode password
		# PAP will decode User-Password (binary) -> Cleartext-Password
		# using the NAS shared secret, even without password reference
		#
		if (&User-Password) {
			update control {
				Auth-Type := PAP
			}
		}
		#
		# PAP decode happens in authenticate section
		# After decode, we'll switch to REST for backend validation
		#
	}

	authenticate {
		Auth-Type PAP {
			#
			# PAP decode: User-Password (binary) -> Cleartext-Password
			# PAP module decodes password using NAS shared secret
			# Cleartext-Password is now available
			#
			pap
			#
			# After PAP decode, call REST module directly
			# REST module will use Cleartext-Password from PAP decode
			#
			update control {
				# REST API secret (hardcoded for simplicity)
				# Default: dev-radius-rest-secret (change if needed)
				# For production, consider using env var: $ENV{RRNET_RADIUS_REST_SECRET}
				&REST-HTTP-Header += "X-RRNET-RADIUS-SECRET: dev-radius-rest-secret"
			}
			rest
			#
			# rlm_rest returns:
			# - ok      → HTTP 2xx with no reply attrs
			# - updated → reply attrs set
			#
			if (ok || updated) {
				ok
			}
		}
		Auth-Type REST {
			update control {
				# REST API secret (hardcoded for simplicity)
				# Default: dev-radius-rest-secret (change if needed)
				# For production, consider using env var: $ENV{RRNET_RADIUS_REST_SECRET}
				&REST-HTTP-Header += "X-RRNET-RADIUS-SECRET: dev-radius-rest-secret"
			}

			rest
			#
			# rlm_rest returns:
			# - ok      → HTTP 2xx with no reply attrs
			# - updated → reply attrs set
			#
			if (ok || updated) {
				ok
			}
		}
	}

	preacct {
		preprocess
	}

	accounting {
		update control {
			# REST API secret (hardcoded for simplicity)
			# Default: dev-radius-rest-secret (change if needed)
			# For production, consider using env var: $ENV{RRNET_RADIUS_REST_SECRET}
			&REST-HTTP-Header += "X-RRNET-RADIUS-SECRET: dev-radius-rest-secret"
		}

		rest
	}
}


