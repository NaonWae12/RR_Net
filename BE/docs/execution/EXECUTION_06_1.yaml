EXECUTION_06_NETWORK_MANAGEMENT_MIKROTIK_RADIUS:
  goal: >
    Provide a robust and scalable network management foundation
    for ISP operations, integrating Mikrotik and RADIUS with
    idempotent provisioning and secure credential handling.

  scope:
    applies_to: backend_only
    depends_on:
      - EXECUTION_01_1_BACKEND_FOUNDATION_HARDENING
      - EXECUTION_05_CUSTOMER_CLIENT_MANAGEMENT

  design_principles:
    - Idempotent provisioning
    - Explicit credential ownership
    - No global state in providers
    - Async-safe for retries

  tasks:
    1_network_schema_migration:
      description: Create network-related schemas
      steps:
        - Add migration under migrations/
        - Create table routers:
            fields:
              - id (uuid)
              - tenant_id (fk)
              - name
              - host
              - api_port
              - username
              - password_encrypted
              - created_at
        - Create table radius_users:
            fields:
              - id (uuid)
              - tenant_id (fk)
              - client_id (fk)
              - username
              - password
              - password_source (enum: client_password | radius_generated)
              - profile
              - created_at
              - deleted_at (nullable)
        - Constraints:
            - unique(tenant_id, username)

    2_mikrotik_provider_interface:
      description: Mikrotik provider abstraction
      rules:
        - Provider must be stateless
      steps:
        - Define interface MikrotikProvider:
            methods:
              - CreateOrUpdateUser(ctx, user) error
              - DisableUser(ctx, username) error
              - EnableUser(ctx, username) error
        - Provider initialization:
            - Accept router credentials via constructor
            - No global config access
        - Idempotency rule:
            - CreateOrUpdateUser:
                - If user exists → update
                - If not exists → create

    3_radius_password_policy:
      description: Explicit RADIUS credential source
      rules:
        - radius_users.password must have clear origin
      steps:
        - Define password_source meanings:
            client_password:
              description: >
                Password identical to client login credentials.
                Change propagates to RADIUS.
            radius_generated:
              description: >
                Password generated by system,
                independent from client login.
        - Enforce password_source is required field
      note:
        - Actual password sync handled in worker later

    4_async_provisioning_worker:
      description: Async network provisioning
      steps:
        - On client creation or update:
            - Enqueue network_provision_job
        - Worker behavior:
            - Load router + radius user data
            - Call CreateOrUpdateUser (idempotent)
            - Safe to retry on failure
        - On billing isolir:
            - Call DisableUser
        - On unisolir:
            - Call EnableUser

    5_rbac_access_rules:
      description: Network module RBAC
      rules:
        - owner/admin:
            - full access
        - technician:
            - view + limited actions
        - finance/collector:
            - no access

  done_criteria:
    - Mikrotik provider is stateless & idempotent
    - RADIUS password source is explicit
    - Router credentials injected safely
    - Network worker safe for retries
    - No global credential leakage

  note:
    - This is foundation only
    - Advanced sync & reconciliation handled later
